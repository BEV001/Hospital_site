{% extends "base.html" %}
{% block title %}Таблица больниц{% endblock %}
{% block head_scripts %}
<style>
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  padding: 8px;
  border: 1px solid #ddd;
}
th {
  background-color: #f0f0f0;
}
</style>
{% endblock %}
{% block content %}
<h1>Таблица больниц</h1>

<form id="filterForm">
    <label>Город:
        <input type="text" name="city" id="cityFilter" placeholder="Введите город" />
    </label>

    <label>
        <input type="checkbox" name="license_lu" value="true" /> Лицензия ЛУ
    </label>
    <label>
        <input type="checkbox" name="hot_beds" value="true" /> Горячие койки
    </label>
    <label>
        <input type="checkbox" name="quotas_vmp_2025" value="true" /> Квоты ВМП 2025
    </label>

    <button type="submit">Применить фильтры</button>
    <button type="button" id="btnAddHospital">Добавить больницу</button>
</form>

<table id="hospitalsTable">
    <thead>
        <tr>
            <th>Название</th>
            <th>Город</th>
            <th>Адрес</th>
            <th>Лицензия ЛУ</th>
            <th>Горячие койки</th>
            <th>Квоты ВМП 2025</th>
            <th>Контакт</th>
            <th>Телефон</th>
            <th>Email</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
    <!-- Данные подгружаются JS -->
    </tbody>
</table>

<!-- Модальное окно для добавления и редактирования -->
<div id="modalContainer" style="display:none;">
    <div id="modalContent" style="background:#fff; padding:20px; border:1px solid #ccc; max-width:600px; margin:40px auto; position:relative;">
        <button id="modalClose" style="position:absolute; top:10px; right:10px;">X</button>
        <div id="modalBody"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function openModal(contentHtml) {
    $('#modalBody').html(contentHtml);
    $('#modalContainer').show();
}

function closeModal() {
    $('#modalContainer').hide();
    $('#modalBody').html('');
}

$('#modalClose').on('click', closeModal);

$('#btnAddHospital').on('click', function() {
    openModal(renderHospitalForm());
});

function renderHospitalForm(hospital = {}) {
    // Если hospital пустой — добавление, иначе редактирование
    return `
<form id="hospitalForm">
    <input type="hidden" name="id" value="${hospital.id || ''}" />
    <label>Название:<br><input type="text" name="name" value="${hospital.name || ''}" required></label><br><br>
    <label>Город:<br><input type="text" name="city" value="${hospital.city || ''}" required></label><br><br>
    <label>Тип улицы:<br><input type="text" name="street_type" value="${hospital.street_type || ''}" required></label><br><br>
    <label>Название улицы:<br><input type="text" name="street_name" value="${hospital.street_name || ''}" required></label><br><br>
    <label>Полный адрес:<br><input type="text" name="address_full" value="${hospital.address_full || ''}" required></label><br><br>
    <label>Широта:<br><input type="number" step="any" name="latitude" value="${hospital.latitude || ''}" required></label><br><br>
    <label>Долгота:<br><input type="number" step="any" name="longitude" value="${hospital.longitude || ''}" required></label><br><br>
    <label><input type="checkbox" name="license_lu" ${hospital.license_lu ? 'checked' : ''}> Лицензия ЛУ</label><br>
    <label><input type="checkbox" name="hot_beds" ${hospital.hot_beds ? 'checked' : ''}> Горячие койки</label><br>
    <label><input type="checkbox" name="quotas_vmp_2025" ${hospital.quotas_vmp_2025 ? 'checked' : ''}> Квоты ВМП 2025</label><br><br>
    <fieldset>
        <legend>Контактная информация</legend>
        <label>ФИО:<br><input type="text" name="contact_full_name" value="${hospital.contact_full_name || ''}" required></label><br><br>
        <label>Должность:<br><input type="text" name="contact_position" value="${hospital.contact_position || ''}" required></label><br><br>
        <label>Телефон:<br><input type="text" name="contact_phone" value="${hospital.contact_phone || ''}" required></label><br><br>
        <label>Email:<br><input type="email" name="contact_email" value="${hospital.contact_email || ''}" required></label><br><br>
    </fieldset>
    <label>Имя файла изображения:<br><input type="text" name="image_filename" value="${hospital.image_filename || ''}"></label><br><br>

    <button type="submit">${hospital.id ? 'Сохранить' : 'Добавить'}</button>
</form>
    `;
}

function fetchHospitals(filters = {}) {
    let params = new URLSearchParams(filters);
    fetch('/api/hospitals?' + params.toString())
    .then(res => res.json())
    .then(data => {
        const tbody = $('#hospitalsTable tbody');
        tbody.empty();
        data.forEach(hospital => {
            const row = $(`
                <tr>
                    <td>${hospital.name}</td>
                    <td>${hospital.city}</td>
                    <td>${hospital.address}</td>
                    <td>${hospital.license_lu ? 'Да' : 'Нет'}</td>
                    <td>${hospital.hot_beds ? 'Да' : 'Нет'}</td>
                    <td>${hospital.quotas_vmp_2025 ? 'Да' : 'Нет'}</td>
                    <td>${hospital.contact_full_name}</td>
                    <td>${hospital.contact_phone}</td>
                    <td>${hospital.contact_email}</td>
                    <td>
                        <button class="editBtn" data-id="${hospital.id}">Редактировать</button>
                    </td>
                </tr>
            `);
            tbody.append(row);
        });
    });
}

$('#filterForm').on('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const filters = {};
    for (const [key, value] of formData.entries()) {
        if (key === 'license_lu' || key === 'hot_beds' || key === 'quotas_vmp_2025') {
            filters[key] = 'true';
        } else if (value.trim() !== '') {
            filters[key] = value;
        }
    }
    fetchHospitals(filters);
});

// Обработка клика на редактирование
$('#hospitalsTable').on('click', '.editBtn', function() {
    const id = $(this).data('id');
    fetch('/api/hospitals?' + new URLSearchParams({id}))
    .then(res => res.json())
    .then(data => {
        // У нас в API нет фильтра по id, поэтому подгрузим по id вручную:
        // Лучше сделать отдельный эндпоинт, но сейчас сделаем так:
        // Ищем больницу в общем списке:
        fetch('/api/hospitals')
        .then(r => r.json())
        .then(allHospitals => {
            const hosp = allHospitals.find(h => h.id === id);
            if (!hosp) {
                alert('Больница не найдена');
                return;
            }
            openModal(renderHospitalForm(hosp));
        });
    });
});

// Обработка отправки формы добавления/редактирования
$('#modalContainer').on('submit', '#hospitalForm', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const id = formData.get('id');
    const data = {
        name: formData.get('name'),
        city: formData.get('city'),
        street_type: formData.get('street_type'),
        street_name: formData.get('street_name'),
        address_full: formData.get('address_full'),
        latitude: parseFloat(formData.get('latitude')),
        longitude: parseFloat(formData.get('longitude')),
        license_lu: formData.get('license_lu') === 'on',
        hot_beds: formData.get('hot_beds') === 'on',
        quotas_vmp_2025: formData.get('quotas_vmp_2025') === 'on',
        contact: {
            full_name: formData.get('contact_full_name'),
            position: formData.get('contact_position'),
            phone: formData.get('contact_phone'),
            email: formData.get('contact_email')
        },
        image: formData.get('image_filename') || null
    };

    if (!id) {
        // Добавление
        fetch('/api/hospitals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => {
            if (res.status === 201) return res.json();
            else throw new Error('Ошибка при добавлении');
        })
        .then(() => {
            alert('Больница добавлена');
            closeModal();
            fetchHospitals();
        })
        .catch(err => alert(err.message));
    } else {
        // Редактирование
        fetch(`/api/hospitals/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => {
            if (res.ok) return res.json();
            else throw new Error('Ошибка при редактировании');
        })
        .then(() => {
            alert('Больница обновлена');
            closeModal();
            fetchHospitals();
        })
        .catch(err => alert(err.message));
    }
});

// Загрузка списка при старте
fetchHospitals();

</script>
{% endblock %}